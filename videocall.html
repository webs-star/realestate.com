<!DOCTYPE html>
<html>
<head>
  <title>Agora Meeting</title>
  <!-- Agora SDK -->
 <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <h2>🔐 Sign In / Sign Up</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>

  <div id="meeting" style="display:none; margin-top: 20px;">
  <h3>📹 Agora Meeting</h3>
  <input id="channelName" placeholder="Channel name"><br><br>

  <!-- Buttons -->
  <button onclick="startMeeting()">Start Meeting</button>
  <button onclick="joinMeeting()">Join Meeting</button>

  <!-- Local Stream -->
  <h4>📷 Your Camera</h4>
  <div id="local-stream" style="width: 640px; height: 480px; margin-bottom: 20px;"></div>

  <!-- Remote Streams -->
  <h4>👥 Participants</h4>
  <div id="remote-streams" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
</div>


  <script>
    // 🔐 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAYztz7z8L3SFOZgCpbwthzTXeuhojDisM",
      authDomain: "lead-tracker-a2181.firebaseapp.com",
      databaseURL: "https://lead-tracker-a2181-default-rtdb.firebaseio.com",
      projectId: "lead-tracker-a2181",
      storageBucket: "lead-tracker-a2181.appspot.com",
      messagingSenderId: "601818438359",
      appId: "1:601818438359:web:44f4c05db3d732d29dee92"
    };
    firebase.initializeApp(firebaseConfig);

    // Show meeting area after login
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById("meeting").style.display = "block";
      }
    });

    function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(() => alert("✅ Signed up"))
        .catch(err => alert("❌ " + err.message));
    }

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(() => alert("✅ Logged in"))
        .catch(err => alert("❌ " + err.message));
    }

    // 🧠 Agora Setup
    const APP_ID = "a28029207e4d45aaa3de6623a57171d1";
    let client;
    let localTracks = {
      videoTrack: null,
      audioTrack: null
    };

async function startMeeting() {
  try {
    if (!window.AgoraRTC || !AgoraRTC.createClient) {
      return alert("❌ AgoraRTC not loaded correctly.");
    }

    const channel = document.getElementById("channelName").value.trim();
    if (!channel) return alert("Please enter a channel name");

    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    await client.join(APP_ID, channel, null);

    const [microphoneTrack, cameraTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
    localTracks.audioTrack = microphoneTrack;
    localTracks.videoTrack = cameraTrack;

    const player = document.createElement("div");
    player.id = "local-player";
    player.style.width = "640px";
    player.style.height = "480px";
    document.getElementById("local-stream").appendChild(player);

    localTracks.videoTrack.play("local-player");

    await client.publish([localTracks.audioTrack, localTracks.videoTrack]);

    // ✅ THIS WAS MISSING
    client.on("user-published", async (user, mediaType) => {
      await client.subscribe(user, mediaType);

      if (mediaType === "video") {
        const remoteDiv = document.createElement("div");
        remoteDiv.id = `remote-player-${user.uid}`;
        remoteDiv.style.width = "320px";
        remoteDiv.style.height = "240px";
        document.getElementById("remote-streams").appendChild(remoteDiv);
        user.videoTrack.play(remoteDiv);
      }

      if (mediaType === "audio") {
        user.audioTrack.play(); // 👂 Audio will now play
      }
    });

    alert("✅ Meeting started!");
  } catch (err) {
    console.error(err);
    alert("❌ Error starting meeting: " + err.message);
  }
}


async function joinMeeting() {
  const channel = document.getElementById("channelName").value.trim();
  if (!channel) return alert("Please enter a channel name");

  try {
    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    // Join channel
    await client.join(APP_ID, channel, null, null);

    // Create local tracks (camera + mic)
    const [localAudioTrack, localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

    // Play your own video
    localVideoTrack.play("local-stream");

    // Publish your tracks so others can see you
    await client.publish([localAudioTrack, localVideoTrack]);

    // Handle remote users
    client.on("user-published", async (user, mediaType) => {
      await client.subscribe(user, mediaType);

      if (mediaType === "video") {
        const remoteDiv = document.createElement("div");
        remoteDiv.id = `remote-player-${user.uid}`;
        remoteDiv.style.width = "320px";
        remoteDiv.style.height = "240px";
        document.getElementById("remote-streams").appendChild(remoteDiv);
        user.videoTrack.play(remoteDiv);
      }

      if (mediaType === "audio") {
        user.audioTrack.play();
      }
    });

    alert("✅ Joined and published your camera!");
  } catch (error) {
    console.error("Error joining meeting:", error);
    alert("❌ Error joining meeting: " + error.message);
  }
}


    
  </script>
</body>
</html>
