<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Custom Video Meeting</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    video { width: 45%; margin: 5px; background: #000; }
    #chat { height:150px; overflow:auto; border:1px solid #ccc; padding:5px; }
  </style>
</head>
<body>
  <h2>ðŸ“ž Login with Phone</h2>
  <input id="phone" placeholder="+254712345678"><button onclick="sendOTP()">Send OTP</button><br>
  <input id="otp" placeholder="123456"><button onclick="verifyOTP()">Verify OTP</button>
  <div id="meetControls" style="display:none">
    <h2>ðŸ”‘ Create/Join Meeting</h2>
    <input id="meetName" placeholder="Meeting Name">
    <button onclick="createMeeting()">Create</button>
    <button onclick="joinMeeting()">Join</button>
  </div>

  <h2>ðŸŽ¥ Video Area</h2>
  <video id="localVid" autoplay muted></video>
  <video id="remoteVid" autoplay></video>

  <h2>ðŸ’¬ Chat</h2>
  <div id="chat"></div>
  <input id="chatMsg" placeholder="Type and hit Enter">

<script>
  // --- Firebase init ---
  const firebaseConfig = {
  apiKey: "AIzaSyAYztz7z8L3SFOZgCpbwthzTXeuhojDisM",
  authDomain: "lead-tracker-a2181.firebaseapp.com",
  databaseURL: "https://lead-tracker-a2181-default-rtdb.firebaseio.com",
  projectId: "lead-tracker-a2181",
  storageBucket: "lead-tracker-a2181.firebasestorage.app",
  messagingSenderId: "601818438359",
  appId: "1:601818438359:web:44f4c05db3d732d29dee92"
};
  const db = firebase.database();

  // --- Phone Auth ---
  let confirmation;
  function sendOTP(){
    const phone = document.getElementById('phone').value;
    window.recaptcha = new firebase.auth.RecaptchaVerifier(document.body, { size: 'invisible' });
    firebase.auth().signInWithPhoneNumber(phone, window.recaptcha)
      .then(c => { confirmation = c; alert('OTP sent'); })
      .catch(console.error);
  }
  function verifyOTP(){
    confirmation.confirm(document.getElementById('otp').value)
      .then(userC => {
        alert('Logged in!');
        document.getElementById('meetControls').style.display = 'block';
      })
      .catch(console.error);
  }

  // --- PeerJS for Video ---
  let localStream, peer, conn, callRef;
  navigator.mediaDevices.getUserMedia({video:true,audio:true})
    .then(s => { localStream = s; document.getElementById('localVid').srcObject = s; });

  function createPeerCallback(meetName){
    peer = new Peer(meetName, { debug: 1 });
    peer.on('open', id => {
      // Listen for incoming calls
      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', remote => document.getElementById('remoteVid').srcObject = remote);
      });
      setupMeeting(meetName);
    });
  }

  function createMeeting(){
    const m = document.getElementById('meetName').value;
    if (!m) return alert('Add meeting name');
    createPeerCallback(m);
  }
  function joinMeeting(){
    const m = document.getElementById('meetName').value;
    if (!m) return alert('Add meeting name');
    peer = new Peer({ debug: 1 });
    peer.on('open', id => {
      const call = peer.call(m, localStream);
      call.on('stream', r => document.getElementById('remoteVid').srcObject = r);
      callRef = call;
      setupMeeting(m);
    });
  }

  // --- Logging and Chat ---
  function setupMeeting(meetName){
    // Log join
    const uid = firebase.auth().currentUser.uid;
    db.ref(`meetings/${meetName}/logs`).push({ uid, at: Date.now() });

    // Chat setup
    const chatRef = db.ref(`meetings/${meetName}/chat`);
    chatRef.on('child_added', snap => {
      const { uid: u, text } = snap.val();
      const div = document.createElement('div');
      div.textContent = `${u}: ${text}`;
      document.getElementById('chat').appendChild(div);
    });

    document.getElementById('chatMsg').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        const txt = e.target.value;
        chatRef.push({ uid, text: txt, at: Date.now() });
        e.target.value = '';
      }
    });
  }
</script>
</body>
</html>
